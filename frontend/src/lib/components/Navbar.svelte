<script lang="ts">
	import { PUBLIC_API_URL } from '$env/static/public';
	import {
		Navbar,
		NavBrand,
		Button,
		DarkMode,
		Dropdown,
		DropdownItem,
		Modal
	} from 'flowbite-svelte';
	import { ArrowRightToBracketSolid } from 'flowbite-svelte-icons';
	import { logged_in } from '../stores';
	import { MailIcon } from 'svelte-feather-icons';
	import { onMount } from 'svelte';
	import { goto, invalidate } from '$app/navigation';

	export let user: User;

	let activeInvitation: Invitation;
	let invitations: Invitation[] = [];

	let dropdownOpen = false;
	let answerInvitationModal = false;

	async function getInvitations() {
		const response = await fetch(`${PUBLIC_API_URL}/get_invitations`, {
			method: 'GET',
			credentials: 'include',
			headers: {
				'Content-Type': 'application/json'
			}
		});
		const js = await response.json();
		invitations = js;
		return { js };
	}

	onMount(getInvitations);

	function handleInviteClick(invitation: Invitation) {
		activeInvitation = invitation;
		answerInvitationModal = true;
	}

	async function enrollUser() {
		const course_id = activeInvitation.course_id;
		const course_semester = activeInvitation.course_semester;
		const uid = activeInvitation.uid;
		const role = activeInvitation.role;

		const response = await fetch(`${PUBLIC_API_URL}/enroll`, {
			method: 'POST',
			credentials: 'include',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				uid: uid,
				course_id: course_id,
				course_semester: course_semester,
				role: role
			})
		});
		const js = await response.json();
		goto('/overview');
		return { js };
	}

	function acceptInvitation() {
		enrollUser();
		deleteInvitation();
	}

	// function for deleting invitation, using DELETE method
	async function deleteInvitation() {
		const invitation_id = activeInvitation.id;
		const response = await fetch(`${PUBLIC_API_URL}/delete_invitation/${invitation_id}`, {
			method: 'DELETE',
			credentials: 'include',
			headers: {
				'Content-Type': 'application/json'
			}
		});
		const js = await response.json();
		invalidate('app:layoutUser');
		invitations = invitations.filter((invitation) => invitation.id !== activeInvitation.id);
		return { js };
	}

	async function handleLogOut() {
		try {
			logged_in.set(false);
			window.location.href = `${PUBLIC_API_URL}/logout`;
		} catch (error) {
			console.error('Logout failed:', error);
			// Handle error (show message, retry, etc.)
		}
	}
</script>

{#if user.detail !== 'You are not logged in' && user !== undefined}
	<Navbar shadow class="p-6 sm:px-3 md:px-15 dark:bg-gray-800">
		<NavBrand href="/overview">
			<img
				src="/logo-horizontal-light.svg"
				alt="Reflection Tool Logo"
				class="me-3 hidden sm:block dark:hidden"
			/>
			<img
				src="/logo-icon-light.svg"
				class="me-3 sm:hidden dark:hidden"
				alt="Reflection Icon Logo"
			/>
			<img
				src="/logo-horizontal-dark.svg"
				alt="Reflection Tool Logo"
				class="me-3 hidden dark:sm:block"
			/>
			<img
				src="/logo-icon-dark.svg"
				class="me-3 hidden dark:max-sm:block"
				alt="Reflection Icon Logo"
			/>
		</NavBrand>
		<div class="flex items-center gap-5">
			<div>
				<span class="hidden sm:inline">Logged in as</span>
				<span class="mr-2 sm:mr-4">{user.uid}</span>
				<DarkMode class="align-bottom text-blue-700 dark:text-yellow-200" />
				<Button on:click={handleLogOut} color="alternative" class="ml-4">
					Log out
					<ArrowRightToBracketSolid class="w-3.5 h-3.5 ms-2" />
				</Button>
			</div>
			<div class="relative mt-0.5">
				{#if invitations.length > 0}
					<div
						class="absolute -top-1 -right-1 flex h-3 w-3 items-center justify-center rounded-full bg-red-500 hover:cursor-default focus:outline-none"
					>
						<span class="select-none text-[12px] font-bold text-white focus:outline-none"
							>{invitations.length}</span
						>
					</div>
				{/if}
				<MailIcon
					class="hover:cursor-pointer  focus:outline-none dark:text-white"
					on:click={() => {
						dropdownOpen = !dropdownOpen;
					}}
				/>
				<Dropdown open={dropdownOpen}>
					{#if invitations.length > 0}
						{#each invitations as invitation}
							<DropdownItem
								class="hover:cursor-pointer focus:outline-none w-60"
								on:click={() => {
									handleInviteClick(invitation);
								}}
							>
								You have been invited to course {invitation.course_id} as: {invitation.role}
							</DropdownItem>
						{/each}
					{:else}
						<DropdownItem>You have no new notifications</DropdownItem>
					{/if}
				</Dropdown>
				<Modal bind:open={answerInvitationModal} size="xs" autoclose={false} class="w-full">
					<h3 class="p-0 text-xl font-medium text-gray-900 dark:text-white">Course invitation</h3>
					<p>
						Are you sure you want to join the course {activeInvitation.course_id} as {activeInvitation.role}?
					</p>
					<Button
						type="submit"
						class="w-full1 bg-teal-13 hover:bg-teal-10 dark:bg-blue-700 dark:hover:bg-blue-600"
						on:click={() => {
							acceptInvitation();
							answerInvitationModal = false;
						}}>Accept</Button
					>

					<Button
						type="submit"
						class="w-full1 bg-teal-13 hover:bg-teal-10 dark:bg-blue-700 dark:hover:bg-blue-600"
						on:click={() => {
							deleteInvitation();
							answerInvitationModal = false;
						}}>Decline</Button
					>
				</Modal>
			</div>
		</div>
	</Navbar>
{/if}
